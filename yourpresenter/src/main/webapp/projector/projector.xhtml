<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:a4j="http://richfaces.org/a4j">
<f:view contentType="text/html">

	<h:head>
		<title><ui:insert name="title">Projector</ui:insert>
		</title>
		<meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />

		<script type="text/javascript" src="../js/jquery-1.7.min.js"></script>
		<script type="text/javascript">
			/* 	as we don't use jQuery distributed with Richfaces => need this
				see: http://docs.jquery.com/Using_jQuery_with_Other_Libraries */
			/* jQuery.noConflict(); */
			var $ = jQuery.noConflict();
		</script>
		
		<script type="text/javascript">
			var preferences = new Array();
			preferences['view.font.maxsize.projector'] = <h:outputText value="#{preferencesView.viewFontMaxsizeProjector}" />;
		</script>
		
		<!-- <script type="text/javascript" src="../js/projector.js"></script> -->
				
		<!-- used to fit text size to box
		see: http://plugins.jquery.com/project/TextFill
		the call is used also for the all oncomplete for ajax events where necessary 
		-->
		<script type="text/javascript" src="../js/jquery-textfill-0.1.js"></script>
		
		<script type="text/javascript">
			var data;
			var state = ""
			var transitionDuration = 500;
			var fgClass = ".one-fg";
			var bgClass = ".one-bg";
			var isBlank = <h:outputText value="#{scheduleView.blank}" />;
			var isClear = <h:outputText value="#{scheduleView.clear}" />;
			var isLive = <h:outputText value="#{scheduleView.live}" />;
			var scheduleName = "<h:outputText value="#{scheduleView.scheduleName}" />";
			var txt = "";
			var bgId = -1;
			var zIdxBehindAll = 0;
			var zIdxFg = 20;
			var zIdxBg = 10;

			jQuery(document).ready(function() {
				/* call function in jQuery: http://stackoverflow.com/questions/907634/is-this-how-you-define-a-function-in-jquery */
				onStart();
			});

			function onStart() {
				setUp();
				queryData();
			}
			
			function setUp() {
				// handle blank/live
				if (isBlank || !isLive) {
					jQuery(".blank").show();
				} else {
					jQuery(".blank").hide();
				}
				
				// set fg/bg visibility
				jQuery(fgClass).show();
				jQuery(alterClass(fgClass)).hide();
				jQuery(bgClass).show();
				jQuery(alterClass(bgClass)).hide();
				
				// handle clear
				if (isClear) {
					jQuery(".template-fg").hide();
				} else {
					jQuery(".template-fg").show();
				}
			}
			
			function queryData() {
				jQuery.getJSON("../mvc/state/" + scheduleName, function(newData) {

					// TODO JSON comparison, see:
					// http://stackoverflow.com/questions/201183/how-do-you-determine-equality-for-two-javascript-objects
					/* alert(jQuery.JSON.encode(newData)===jQuery.JSON.encode(data)); 

					// in case nothing changed => do nothing
					if (newData == data) {
						alert("no update");
						return;
					}
					*/

					var newTxt = newData.actualSlide.verse.text;
					var newIsBlank = newData.schedule.blank; 
					var newIsClear = newData.schedule.clear;
					var newIsLive = newData.schedule.live;
					var newBgId = -1;
					
					if (newData.actualSlide.bgImage != null) {
						var newBgId = newData.actualSlide.bgImage.id	
					}
					
					// blank or live toggled
					if ((newIsBlank != isBlank)
							|| (newIsLive != isLive)) {
						if (newIsBlank || !newIsLive) {
							jQuery(".blank").fadeIn(transitionDuration);
						} else {
							jQuery(".blank").fadeOut(transitionDuration);
						}
						isBlank = newIsBlank;
						isLive = newIsLive;
					}
					
					// clear toggled
					if (newIsClear != isClear) {
						if (newIsClear) {
							jQuery(".template-fg").fadeOut(transitionDuration);
						} else {
							jQuery(".template-fg").fadeIn(transitionDuration);
						}
						isClear = newIsClear; 
					}
					
 					// txt changed
 					if (newTxt != txt) {
						var newFgClass = alterClass(fgClass);
						
						// set new txt
						jQuery(newFgClass).css("z-index", zIdxBehindAll);
						jQuery(newFgClass).children(".jtextfill").children(".jtextfill-inner").html(newTxt);
						
						// align size only for non-empty txt
						if (newTxt != "") {
							jQuery(newFgClass).children(".jtextfill").textfill({maxFontPixels : preferences['view.font.maxsize.projector']});	
						}
						 
						//
						// hide old and show new
						//
						
						// hide new and move it in front
						jQuery(newFgClass).hide();
						jQuery(newFgClass).css("z-index", zIdxFg + 1);

						// if to be displayed do the effect
						if (!isClear) {
							jQuery(fgClass).fadeOut(transitionDuration);
							// jQuery(newFgClass).fadeIn(transitionDuration);
							jQuery(newFgClass).fadeIn(transitionDuration, 
									function () {
										jQuery(newFgClass).css("z-index", zIdxFg);
							});
						} else {
							jQuery(newFgClass).css("z-index", zIdxFg);
						}

						txt = newTxt;
						fgClass = newFgClass;
					} 

					// bg changed
 					if ( newBgId != bgId) {
						var newBgClass = alterClass(bgClass);
						
						// put new bg div to the back
						jQuery(newBgClass).css("z-index", zIdxBehindAll);
						jQuery(newBgClass).show();
						
						if (newBgId == -1) {
							jQuery(newBgClass).css({"background-image":"none"});
						} else {
							var imgPath = "/yourpresenter/mvc/image/" + newBgId;
							jQuery(newBgClass).css({"background-image":"url('" + imgPath + "')"}); 
						} 

						//
						// hide old and show new
						//
						
						jQuery(newBgClass).hide();
						jQuery(newBgClass).css("z-index", zIdxBg + 1);
						
 						// hide old and show new
						jQuery(bgClass).fadeOut(transitionDuration);
						jQuery(newBgClass).fadeIn(transitionDuration, 
								function () {
									jQuery(newBgClass).css("z-index", zIdxBg);
						});
						
						bgId = newBgId;
						bgClass = newBgClass;
					}
				
					/* preload bg image first, fade it in only afterwards
						see: http://stackoverflow.com/questions/5365509/calling-a-function-when-the-background-image-finishes-loading */
					/*
					var img = new Image();
					img.onload = function() {
						// css + jquery: http://www.jquery4u.com/dynamic-css-2/change-css-jquery/
						jQuery(".one-bg").css({"background-image":"url('" + imgPath + "')"});
						
						jQuery(".one-bg").fadeIn(transitionDuration); 
						// jQuery(".one-bg").fadeIn(transitionDuration, function() {
						//	jQuery(".one-fg").children(":first").children(":first").html(newData.actualSlide.verse.text);
						//	jQuery(".jtextfill").textfill({maxFontPixels : 70});  
						//	jQuery(".one-fg").fadeIn(transitionDuration);
						//}); 
						jQuery(".one-fg").children(":first").children(":first").html(newData.actualSlide.verse.text);
						jQuery(".jtextfill").textfill({maxFontPixels : 70});  
						jQuery(".one-fg").fadeIn(transitionDuration);
					};
					img.src = imgPath;
					*/
					
					data = newData;
				});
				
				setTimeout('queryData()', 1000);
			}
			
			function alterClass(oldClass) {
				var newClass = "";
				if (oldClass.substring(0, ".one".length) === ".one") {
					newClass = oldClass.replace("one", "two");
				} else {
					newClass = oldClass.replace("two", "one");
				}
				return newClass; 
			}
		</script>

		<style type="text/css">

/* fullscreen div idea found: http://stackoverflow.com/questions/2217007/how-to-make-a-div-fullscreen-and-atop-of-all-other-elements-with-jquery */
.board {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background-color: black;
	padding: 0pt;
	border: 0px;
	/* border: 1px; 
	border-style: solid;
	border-color: #00ff00; */
	z-index: 1;
}

.blank {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background-color: black;
	padding: 0pt;
	border: 0px;
	/* border: 1px; 
	border-style: solid;
	border-color: #00ff00; */
	z-index: 100;
}

.template-bg {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	/* background-color: black; */
	padding: 0pt;
	border: 0px;
	z-index: 20;
	background-size: cover;
	background-repeat: no-repeat;
	background-position: center;
}

.template-fg {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: transparent;
	padding: 0pt;
	border: 0px;
	z-index: 30;
	/* border around text needed */
	/* padding: 10%; */
	/* by default hidden */
	margin:auto;
	
	/* display: none; */
	display: table;
	table-layout:fixed;
}

.one-bg .one-fg .two-bg .two-fg {
	opacity: 0;
}

/* [BEGIN] slide styles */
.jtextfill {
	padding: 5%; 
	/* border: 2px;
	border-style: solid;
	border-color: #00ff00; */
	border: 0px;
	
	/* make background transparent */
	background: transparent;

	color: white;
	
	/* text with border */
	color: white;
	/* text-shadow: -2px 0 #000, 0 2px #000, 2px 0 #000, 0 -2px #000; */
	text-shadow: 2px -2px 3px #000;
	/* text-decoration: none; */
	font-family: Verdana, Helvetica, sans-serif;
	font-smooth: always;
	/* wrap text on explicit line breaks only */
	white-space: nowrap;

	text-align: center;	
	display:table-cell;
	vertical-align: middle;
} 
.jtextfill-inner {
	/* border: 2px;
	border-style: solid;
	border-color: #00ff00; */
	border: 0px;
}

.jtextfill-inner a { /* TODO check */
	/* prevent underlined text in slides in google chrome/safari */
	text-decoration: none
}
/* [END] slide styles */

</style>
	</h:head>
	<h:body>
		<!-- default background -->
		<div class="board"></div>
			
		<div class="template-bg one-bg"></div>
		<div class="template-bg two-bg"></div>
		
		<div class="template-fg one-fg">
			<div class="jtextfill">
			<span class="jtextfill-inner"></span>
		</div>
		</div>
		
		<div class="template-fg two-fg">
			<div class="jtextfill">
			<span class="jtextfill-inner"></span>
		</div>
		</div>
		
		<div class="blank"></div>
	</h:body>
</f:view>
</html>